apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-cdn-nginx
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  nginx-analytics.json: |
    {
      "id": null,
      "title": "CDN Nginx Aggregated Metrics",
      "schemaVersion": 36,
      "version": 1,
      "refresh": "30s",
      "datasource": {
        "type": "prometheus",
        "uid": "PF4B74AA7F0FE8DA4"
      }

      "templating": {
        "list": [
          {
            "name": "cluster",
            "type": "query",
            "label": "Cluster",
            "datasource": "vmaggregator",
            "query": "label_values(nginx_http_requests_total:2m_rate_sum, cluster)",
            "includeAll": true,
            "multi": true
          },
          {
            "name": "namespace",
            "type": "query",
            "label": "Namespace",
            "datasource": "vmaggregator",
            "query": "label_values(nginx_http_requests_total:2m_rate_sum{cluster=~\"$cluster\"}, namespace)",
            "includeAll": true,
            "multi": true
          },
          {
            "name": "job",
            "type": "query",
            "label": "Job",
            "datasource": "vmaggregator",
            "query": "label_values(nginx_http_requests_total:2m_rate_sum{cluster=~\"$cluster\", namespace=~\"$namespace\"}, job)",
            "includeAll": true,
            "multi": true
          },
          {
            "name": "server_name",
            "type": "query",
            "label": "Stream Server",
            "datasource": "vmaggregator",
            "query": "label_values(nginx_stream_connections_total:2m_rate_sum{cluster=~\"$cluster\"}, server_name)",
            "includeAll": true,
            "multi": true
          }
        ]
      },

      "panels": [

        {
          "datasource": {
            "type": "prometheus",
            "uid": "PF4B74AA7F0FE8DA4"
          },
          "title": "HTTP Request Rate (req/s)",
          "type": "timeseries",
          "targets": [
            {
              "expr": "sum(nginx_http_requests_total:2m_rate_sum{cluster=~\"$cluster\", namespace=~\"$namespace\", job=~\"$job\"})",
              "legendFormat": "requests"
            }
          ]
        },

        {
          "datasource": {
            "type": "prometheus",
            "uid": "PF4B74AA7F0FE8DA4"
          },
          "title": "HTTP Latency Quantiles (p50/p90/p95/p99)",
          "type": "timeseries",
          "targets": [
            {
              "expr": "histogram_quantile(0.50, sum(nginx_http_request_duration_seconds_bucket:2m_rate_sum{cluster=~\"$cluster\", namespace=~\"$namespace\", job=~\"$job\"}) by (le))",
              "legendFormat": "p50"
            },
            {
              "expr": "histogram_quantile(0.90, sum(nginx_http_request_duration_seconds_bucket:2m_rate_sum{cluster=~\"$cluster\", namespace=~\"$namespace\", job=~\"$job\"}) by (le))",
              "legendFormat": "p90"
            },
            {
              "expr": "histogram_quantile(0.95, sum(nginx_http_request_duration_seconds_bucket:2m_rate_sum{cluster=~\"$cluster\", namespace=~\"$namespace\", job=~\"$job\"}) by (le))",
              "legendFormat": "p95"
            },
            {
              "expr": "histogram_quantile(0.99, sum(nginx_http_request_duration_seconds_bucket:2m_rate_sum{cluster=~\"$cluster\", namespace=~\"$namespace\", job=~\"$job\"}) by (le))",
              "legendFormat": "p99"
            }
          ]
        },

        {
          "datasource": {
            "type": "prometheus",
            "uid": "PF4B74AA7F0FE8DA4"
          },
          "title": "Request Size Quantiles (bytes)",
          "type": "timeseries",
          "targets": [
            {
              "expr": "histogram_quantile(0.50, sum(nginx_http_request_size_bytes_bucket:2m_rate_sum{cluster=~\"$cluster\", namespace=~\"$namespace\", job=~\"$job\"}) by (le))",
              "legendFormat": "p50"
            },
            {
              "expr": "histogram_quantile(0.90, sum(nginx_http_request_size_bytes_bucket:2m_rate_sum{cluster=~\"$cluster\", namespace=~\"$namespace\", job=~\"$job\"}) by (le))",
              "legendFormat": "p90"
            }
          ]
        },

        {
          "datasource": {
            "type": "prometheus",
            "uid": "PF4B74AA7F0FE8DA4"
          },
          "title": "HTTP Average Request Duration (ms)",
          "type": "timeseries",
          "targets": [
            {
              "expr": "sum(nginx_http_request_duration_seconds_sum:2m_rate_sum{cluster=~\"$cluster\", namespace=~\"$namespace\", job=~\"$job\"}) / sum(nginx_http_request_duration_seconds_count:2m_rate_sum{cluster=~\"$cluster\", namespace=~\"$namespace\", job=~\"$job\"}) * 1000",
              "legendFormat": "avg latency"
            }
          ]
        },

        {
          "datasource": {
            "type": "prometheus",
            "uid": "PF4B74AA7F0FE8DA4"
          },
          "title": "Stream Connections (per server_name)",
          "type": "timeseries",
          "targets": [
            {
              "expr": "sum(nginx_stream_connections_total:2m_rate_sum{cluster=~\"$cluster\", server_name=~\"$server_name\"})",
              "legendFormat": "{{ `{{server_name}}` }}"
            }
          ]
        },

        {
          "datasource": {
            "type": "prometheus",
            "uid": "PF4B74AA7F0FE8DA4"
          },
          "title": "Total Stream Connections Rate",
          "type": "timeseries",
          "targets": [
            {
              "expr": "sum(nginx_stream_connections_total:2m_rate_sum{cluster=~\"$cluster\"})",
              "legendFormat": "connections"
            }
          ]
        }

      ]
    }
