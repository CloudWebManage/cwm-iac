sources:
  minio_audit:
    type: http_server
    address: 0.0.0.0:8791
    decoding:
      codec: json
    path: ""
    strict_path: false

transforms:
  parse_and_route:
    type: remap
    inputs:
      - minio_audit
    source: |
      # Extract bucket from api.bucket
      if exists(.api.bucket) {
        .bucket, err = to_string(.api.bucket)
        if err != null {
          .bucket = "unknown"
        }
      } else {
        .bucket = "unknown"
      }

      # Extract access key - prefer parentUser for proper attribution with STS tokens
      if exists(.parentUser) {
        .access_key, err = to_string(.parentUser)
        if err != null {
          .access_key = "unknown"
        }
      } else if exists(.accessKey) {
        .access_key, err = to_string(.accessKey)
        if err != null {
          .access_key = "unknown"
        }
      } else {
        .access_key = "unknown"
      }

      .direction = "in"
      if exists(.api.name) {
          api_op, err = to_string(.api.name)
          if err == null {
            if api_op == "GetObject" {
                .direction = "out"
            } else {
                .direction = "in"
            }
          }
      }

      # Extract bytes received (rx) - data only, no headers
      if exists(.api.rx) {
        .rx, err = to_int(.api.rx)
        if err != null {
          .rx = 0
        }
      } else {
        .rx = 0
      }

      # Extract bytes transmitted (tx) - response body
      if exists(.api.tx) {
        .tx, err = to_int(.api.tx)
        if err != null {
          .tx = 0
        }
      } else {
        .tx = 0
      }

      # Extract bytes transmitted headers (txHeaders) - response headers
      if exists(.api.txHeaders) {
        .txHeaders, err = to_int(.api.txHeaders)
        if err != null {
          .txHeaders = 0
        }
      } else {
        .txHeaders = 0
      }

      # Total bytes sent = response body + response headers
      .tx = .tx + .txHeaders

  to_metrics:
    type: log_to_metric
    inputs:
      - parse_and_route
    metrics:
      - type: counter
        field: bucket
        name: minio_audit_operations
        tags:
          bucket: "{{bucket}}"
          access_key: "{{access_key}}"
          direction: "{{direction}}"
      - type: counter
        field: rx
        name: minio_audit_bytes_received
        tags:
          bucket: "{{bucket}}"
          access_key: "{{access_key}}"
        increment_by_value: true
      - type: counter
        field: tx
        name: minio_audit_bytes_sent
        tags:
          bucket: "{{bucket}}"
          access_key: "{{access_key}}"
        increment_by_value: true

sinks:
  prom_exporter:
    type: prometheus_exporter
    inputs:
      - to_metrics
    address: 0.0.0.0:8799
